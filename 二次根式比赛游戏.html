<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡æ ¹å¼å·…å³°å¯¹å†³ (PKç‰ˆ)</title>
    <style>
        :root {
            --p1-color: #4a90e2; /* è“æ–¹ */
            --p1-bg: #ebf5ff;
            --p2-color: #e74c3c; /* çº¢æ–¹ */
            --p2-bg: #fff0f0;
            --text-color: #2c3e50;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #333;
        }

        /* é¡¶éƒ¨å…¬å…±ä¿¡æ¯æ  */
        #top-bar {
            height: 60px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #timer {
            background: #34495e;
            padding: 5px 20px;
            border-radius: 20px;
            border: 2px solid #7f8c8d;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸ - å·¦å³åˆ†å± */
        #game-arena {
            flex: 1;
            display: flex;
            position: relative;
        }

        /* ç©å®¶åŒºåŸŸé€šç”¨æ ·å¼ */
        .player-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
            transition: opacity 0.3s;
        }

        .player-zone.winner { background-color: #d4efdf; }
        .player-zone.loser { opacity: 0.5; filter: grayscale(0.8); }

        #p1-zone { background: var(--p1-bg); border-right: 2px solid #bdc3c7; }
        #p2-zone { background: var(--p2-bg); }

        /* ç©å®¶å¤´éƒ¨ä¿¡æ¯ */
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 10px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .p1-name { color: var(--p1-color); }
        .p2-name { color: var(--p2-color); }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 8px;
            width: 100px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; width: 0%; transition: width 0.3s; }
        #p1-progress { background: var(--p1-color); }
        #p2-progress { background: var(--p2-color); }

        /* å¡ç‰‡ç½‘æ ¼ - é€‚é…å¹³æ¿ */
        .grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4åˆ— */
            grid-template-rows: repeat(4, 1fr);    /* 4è¡Œ */
            gap: 8px;
            padding: 5px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            border-bottom: 4px solid #ccc;
            transition: transform 0.1s;
        }

        .card:active { transform: scale(0.95); border-bottom-width: 0; margin-top: 4px; }

        /* é€‰ä¸­çŠ¶æ€ */
        #p1-zone .card.selected { border: 2px solid var(--p1-color); background: #e8f4fd; transform: translateY(-2px); }
        #p2-zone .card.selected { border: 2px solid var(--p2-color); background: #fdedec; transform: translateY(-2px); }

        /* åŒ¹é…æˆåŠŸ */
        .card.matched {
            visibility: hidden; /* åŒ¹é…åç›´æ¥æ¶ˆå¤± */
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        /* åŒ¹é…å¤±è´¥æŠ–åŠ¨ */
        .card.shake { animation: shake 0.4s; background: #fab1a0; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* æ•°å­¦å…¬å¼æ¸²æŸ“ */
        .math-box {
            font-family: 'Times New Roman', serif;
            font-size: 1.4rem; /* å¹³æ¿ä¸Šå­—ä½“é€‚ä¸­ */
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .sqrt-sym { font-size: 1.1em; margin-right: 1px; }
        .sqrt-in { border-top: 2px solid currentColor; padding-top: 1px; margin-top: 0.1em; }
        .coef { margin-right: 2px; }

        /* é®ç½©å±‚ (å¼€å§‹/ç»“æŸ) */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: white;
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { margin: 0 0 10px 0; color: #2c3e50; }
        p { font-size: 1.2rem; color: #7f8c8d; }

        .btn {
            background: linear-gradient(to right, #4a90e2, #9b59b6);
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.05); }

        #result-title { font-size: 3rem; margin-bottom: 20px; display: block; }
        .win-p1 { color: var(--p1-color); }
        .win-p2 { color: var(--p2-color); }

        /* å€’è®¡æ—¶åŠ¨ç”» */
        #countdown {
            font-size: 8rem;
            color: white;
            font-weight: bold;
            display: none;
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* é€‚é…ç«–å±æç¤º */
        @media (orientation: portrait) {
            body::after {
                content: "è¯·æ—‹è½¬å¹³æ¿è‡³æ¨ªå±æ¨¡å¼ä»¥è·å¾—æœ€ä½³å¯¹æˆ˜ä½“éªŒ";
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #2c3e50; color: white;
                display: flex; justify-content: center; align-items: center;
                z-index: 200; font-size: 1.5rem; text-align: center; padding: 20px;
            }
        }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="timer">00:00</div>
</div>

<div id="game-arena">
    <!-- ç©å®¶1 (å·¦) -->
    <div class="player-zone" id="p1-zone">
        <div class="player-header">
            <span class="p1-name">ğŸ”µ è“é˜Ÿ (P1)</span>
            <div class="progress-bar"><div class="progress-fill" id="p1-progress-fill"></div></div>
        </div>
        <div class="grid" id="p1-grid"></div>
    </div>

    <!-- ç©å®¶2 (å³) -->
    <div class="player-zone" id="p2-zone">
        <div class="player-header">
            <span class="p2-name">ğŸ”´ çº¢é˜Ÿ (P2)</span>
            <div class="progress-bar"><div class="progress-fill" id="p2-progress-fill"></div></div>
        </div>
        <div class="grid" id="p2-grid"></div>
    </div>
</div>

<!-- æ¸¸æˆæ§åˆ¶å±‚ -->
<div id="overlay">
    <div class="modal" id="start-modal">
        <h1>âš”ï¸ äºŒæ¬¡æ ¹å¼å·…å³°å¯¹å†³</h1>
        <p>å¹³æ¿åŒäººPKæ¨¡å¼</p>
        <p>è§„åˆ™ï¼šå·¦å³åŒæ–¹é¢˜ç›®ç›¸åŒï¼Œçœ‹è°å…ˆæ¶ˆå®Œï¼</p>
        <button class="btn" onclick="startCountdown()">å¼€å§‹å¯¹æˆ˜</button>
    </div>

    <div class="modal" id="end-modal" style="display: none;">
        <span id="result-title"></span>
        <p>è€—æ—¶: <span id="final-time">0</span> ç§’</p>
        <button class="btn" onclick="startCountdown()">å†æ¥ä¸€å±€</button>
    </div>

    <div id="countdown">3</div>
</div>

<script>
    // --- 1. è‡ªåŠ¨ç”Ÿæˆæµ·é‡é¢˜åº“ (æ ¸å¿ƒç®—æ³•) ---
    function generateDatabase() {
        const db = [];
        // å®šä¹‰å¸¸è§çš„æ ¹å·å†…æ•°å­— (b)
        const radicands = [2, 3, 5, 6, 7, 10, 11, 13, 14, 15]; 
        // å®šä¹‰ç³»æ•°èŒƒå›´ (a)
        const maxCoef = 10; 

        radicands.forEach(b => {
            for (let a = 2; a <= maxCoef; a++) {
                const rawVal = a * a * b; // åŸå¼æ•°å€¼ = a^2 * b
                
                // è¿‡æ»¤æ‰æ•°å€¼è¿‡å¤§çš„é¢˜ç›®ï¼Œä¿æŒåœ¨å­¦ç”Ÿå£ç®—/ç®€å•ç¬”ç®—èŒƒå›´å†…
                if (rawVal <= 500) { 
                    db.push({
                        raw: rawVal, // âˆšraw
                        coef: a,     // a
                        rad: b       // âˆšb
                    });
                }
            }
        });
        return db;
    }

    const FULL_DB = generateDatabase(); 
    // console.log(`å·²ç”Ÿæˆ ${FULL_DB.length} é“é¢˜ç›®`); // æµ‹è¯•ç”¨

    // --- æ¸¸æˆçŠ¶æ€ ---
    const GAME_CONFIG = {
        pairsPerGame: 8, // æ¯äºº8å¯¹å¡ç‰‡ (16å¼ )
    };

    let gameState = {
        isPlaying: false,
        startTime: 0,
        timerInterval: null,
        p1: { selected: [], matches: 0, locked: false },
        p2: { selected: [], matches: 0, locked: false }
    };

    // --- DOM å…ƒç´  ---
    const dom = {
        p1Grid: document.getElementById('p1-grid'),
        p2Grid: document.getElementById('p2-grid'),
        timer: document.getElementById('timer'),
        overlay: document.getElementById('overlay'),
        startModal: document.getElementById('start-modal'),
        endModal: document.getElementById('end-modal'),
        countdown: document.getElementById('countdown'),
        resultTitle: document.getElementById('result-title'),
        finalTime: document.getElementById('final-time'),
        p1Bar: document.getElementById('p1-progress-fill'),
        p2Bar: document.getElementById('p2-progress-fill'),
        p1Zone: document.getElementById('p1-zone'),
        p2Zone: document.getElementById('p2-zone')
    };

    // --- è¾…åŠ©å‡½æ•° ---
    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function renderMath(isSimple, val, coef, rad) {
        if (!isSimple) {
            return `<div class="math-box">
                        <span class="sqrt-sym">âˆš</span><span class="sqrt-in">${val}</span>
                    </div>`;
        } else {
            return `<div class="math-box">
                        <span class="coef">${coef}</span>
                        <span class="sqrt-sym">âˆš</span><span class="sqrt-in">${rad}</span>
                    </div>`;
        }
    }

    // --- æ¸¸æˆæµç¨‹ ---
    function startCountdown() {
        dom.startModal.style.display = 'none';
        dom.endModal.style.display = 'none';
        dom.countdown.style.display = 'block';
        
        let count = 3;
        dom.countdown.innerText = count;
        
        // é¢„å…ˆç”Ÿæˆæ•°æ®ï¼Œé˜²æ­¢å¡é¡¿
        prepareGameData();

        const interval = setInterval(() => {
            count--;
            if (count > 0) {
                dom.countdown.innerText = count;
            } else {
                clearInterval(interval);
                dom.countdown.style.display = 'none';
                dom.overlay.style.display = 'none';
                startGame();
            }
        }, 800);
    }

    function prepareGameData() {
        // é‡ç½® UI
        dom.p1Grid.innerHTML = '';
        dom.p2Grid.innerHTML = '';
        dom.p1Bar.style.width = '0%';
        dom.p2Bar.style.width = '0%';
        dom.p1Zone.className = 'player-zone';
        dom.p2Zone.className = 'player-zone';
        dom.timer.innerText = '00.0';

        // é‡ç½®çŠ¶æ€
        gameState = {
            isPlaying: true,
            startTime: Date.now(),
            timerInterval: null,
            p1: { selected: [], matches: 0, locked: false },
            p2: { selected: [], matches: 0, locked: false }
        };

        // 1. æŠ½å–é¢˜ç›® (ä¿è¯ä¸¤è¾¹é¢˜ç›®ä¸€æ ·)
        const selectedQuestions = shuffle([...FULL_DB]).slice(0, GAME_CONFIG.pairsPerGame);

        // 2. ç”Ÿæˆå¡ç‰‡ç»„ (raw å’Œ sim)
        let deckBase = [];
        selectedQuestions.forEach((q, idx) => {
            deckBase.push({ id: idx, type: 'raw', html: renderMath(false, q.raw) });
            deckBase.push({ id: idx, type: 'sim', html: renderMath(true, null, q.coef, q.rad) });
        });

        // 3. åˆ†åˆ«ä¸º P1 å’Œ P2 æ‰“ä¹±å¡ç‰‡ (é¡ºåºä¸åŒï¼Œé¢˜ç›®ç›¸åŒ)
        const p1Deck = shuffle([...deckBase]); // æµ…æ‹·è´åæ‰“ä¹±
        const p2Deck = shuffle([...deckBase]); 

        // 4. æ¸²æŸ“
        renderGrid(dom.p1Grid, p1Deck, 'p1');
        renderGrid(dom.p2Grid, p2Deck, 'p2');
    }

    function renderGrid(gridEl, deck, playerKey) {
        deck.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = item.html;
            card.dataset.id = item.id;
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œä¼ å…¥ç©å®¶æ ‡è¯†
            card.addEventListener('mousedown', (e) => handleInput(e, playerKey, card));
            card.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e, playerKey, card); }); // ä¼˜åŒ–è§¦æ‘¸
            gridEl.appendChild(card);
        });
    }

    function startGame() {
        gameState.startTime = Date.now();
        gameState.timerInterval = setInterval(() => {
            const diff = (Date.now() - gameState.startTime) / 1000;
            dom.timer.innerText = diff.toFixed(1);
        }, 100);
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function handleInput(e, pKey, card) {
        if (!gameState.isPlaying) return;
        const pState = gameState[pKey];

        // æ£€æŸ¥é”å®šã€å·²é€‰ã€å·²æ¶ˆé™¤
        if (pState.locked || card.classList.contains('selected') || card.classList.contains('matched')) return;

        // é€‰ä¸­
        card.classList.add('selected');
        pState.selected.push(card);

        // åˆ¤å®š
        if (pState.selected.length === 2) {
            pState.locked = true; // é”å®šè¯¥ç©å®¶ï¼Œé˜²æ­¢é€‰ç¬¬ä¸‰å¼ 
            checkMatch(pKey);
        }
    }

    function checkMatch(pKey) {
        const pState = gameState[pKey];
        const [c1, c2] = pState.selected;
        const isMatch = c1.dataset.id === c2.dataset.id;

        if (isMatch) {
            // åŒ¹é…æˆåŠŸ
            setTimeout(() => {
                c1.classList.remove('selected');
                c2.classList.remove('selected');
                c1.classList.add('matched');
                c2.classList.add('matched');
                
                pState.matches++;
                updateProgress(pKey);
                
                pState.selected = [];
                pState.locked = false;

                // æ£€æŸ¥èƒœåˆ©
                if (pState.matches === GAME_CONFIG.pairsPerGame) {
                    gameOver(pKey);
                }
            }, 200);
        } else {
            // åŒ¹é…å¤±è´¥
            setTimeout(() => {
                c1.classList.add('shake');
                c2.classList.add('shake');
            }, 200);

            setTimeout(() => {
                c1.classList.remove('selected', 'shake');
                c2.classList.remove('selected', 'shake');
                pState.selected = [];
                pState.locked = false;
            }, 600);
        }
    }

    function updateProgress(pKey) {
        const percent = (gameState[pKey].matches / GAME_CONFIG.pairsPerGame) * 100;
        const barId = pKey + '-progress-fill';
        document.getElementById(barId).style.width = percent + '%';
    }

    function gameOver(winnerKey) {
        gameState.isPlaying = false;
        clearInterval(gameState.timerInterval);

        // UI è§†è§‰åé¦ˆ
        if (winnerKey === 'p1') {
            dom.resultTitle.innerHTML = "ğŸ† è“é˜Ÿè·èƒœ!";
            dom.resultTitle.className = "win-p1";
            dom.p1Zone.classList.add('winner');
            dom.p2Zone.classList.add('loser');
        } else {
            dom.resultTitle.innerHTML = "ğŸ† çº¢é˜Ÿè·èƒœ!";
            dom.resultTitle.className = "win-p2";
            dom.p2Zone.classList.add('winner');
            dom.p1Zone.classList.add('loser');
        }

        dom.finalTime.innerText = dom.timer.innerText;
        
        setTimeout(() => {
            dom.overlay.style.display = 'flex';
            dom.endModal.style.display = 'block';
        }, 1000);
    }

</script>
</body>
</html>